```js
const bucket = new Set()
const ref = (data) => {
  return new Proxy(data, {
    get(target, key) {
      bucket.add(effect) // å†™æ­»ä½¿ç”¨dataæ•°æ®çš„æ˜¯ effect å‡½æ•°
      return target[key]
    },

    set(target, key, newVal) {
      target[key] = newVal
      bucket.forEach(fn => fn()) // å…¨éƒ¨æ‰§è¡Œ
      return true
    }
  })
}

const data = { text: 'hello world' }
const refData = ref(data)
function effect() {
  const res = refData.text
  console.log(res) // ä¸€èˆ¬ä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œæ“ä½œdomï¼Œæˆ–å…¶ä»–å…±äº«çŠ¶æ€
}

effect()
setTimeout(() => {
  refData.text = 'hello vue3'
}, 1000);
```

ç¡¬ç¼–ç ä½¿ç”¨å“åº”å¼æ•°æ®(è¢«è‡ªåŠ¨æ‰§è¡Œ)çš„æ˜¯ effectåå‡½æ•°

å‰¯ä½œç”¨å‡½æ•°ä¹Ÿå­˜èµ·æ¥ `createEffect`
```js
let activeEffect = null // <-- âœ¨ ä¸´æ—¶å˜é‡ å­˜éœ€è¦è®°å½•çš„å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹)
const createEffect = (fn) => {
  activeEffect = fn
  fn()
}

const bucket = new Set()
const ref = (data) => {
  return new Proxy(data, {
    get(target, key) {
      bucket.add(activeEffect) // å†™æ­»ä½¿ç”¨dataæ•°æ®çš„æ˜¯ activeEffect å˜é‡
      return target[key]
    },

    set(target, key, newVal) {
      target[key] = newVal
      bucket.forEach(fn => fn()) // å…¨éƒ¨æ‰§è¡Œ
      return true
    }
  })
}

const data = { text: 'hello world' }
const refData = ref(data)
function effect() {
  const res = refData.text
  console.log(res) // ä¸€èˆ¬ä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œæ“ä½œdomï¼Œæˆ–å…¶ä»–å…±äº«çŠ¶æ€
}

createEffect(effect) // <-- âœ¨ è®°å½•å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹) é¿å…å†™æ­»ä½¿ç”¨æ–¹å‡½æ•°å
setTimeout(() => {
  refData.text = 'hello vue3'
}, 1000);
```


æ­¤æ—¶å“åº”å¼æ•°æ®å¯¹åº”çš„ä½¿ç”¨æ–¹è‡ªåŠ¨æ‰§è¡Œé€»è¾‘ï¼Œå¹¶æ²¡ç”¨åšåˆ°å…·ä½“çš„å±æ€§å¯¹åº”å…·ä½“çš„ä½¿ç”¨æ–¹(å‰¯ä½œç”¨)å‡½æ•°

æˆ‘ä»¬æ‹ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»

ä¸€ä¸ªå“åº”å¼æ•°æ®å¯¹è±¡ å¯¹åº”å¤šä¸ªå±æ€§
ä¸€ä¸ªå±æ€§ å¯¹åº”å¤šä¸ªä½¿ç”¨æ–¹(å‰¯ä½œç”¨)å‡½æ•°
```js
const bucket = new Map([
  [Obj, new Map([
    [ key, new Set([fn1, fn2]) ],
    // ... other key
  ])],
  // ...other Obj
])
```


```js
let activeEffect = null // <-- âœ¨ ä¸´æ—¶å˜é‡ å­˜éœ€è¦è®°å½•çš„å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹)
const createEffect = (fn) => {
  activeEffect = fn
  fn()
}

const bucket = new Map()
const ref = (data) => {
  return new Proxy(data, {
    get(target, key) {

      const depsMap = bucket.get(target)
      if(!depsMap) {
        bucket.set(target, new Map())
      }

      const depsFns = depsMap.get(key) // <-- âŒ TypeError: Cannot read property 'get' of undefined
      if(!depsFns) {
        depsMap.set(key, new Set())
      }

      depsFns.add(activeEffect) // å†™æ­»ä½¿ç”¨dataæ•°æ®çš„æ˜¯ activeEffect å˜é‡
      return target[key]
    },

    set(target, key, newVal) {
      target[key] = newVal

      const depsMap = bucket.get(target)
      const depsFns = depsMap.get(key)
      depsFns.forEach(fn => fn()) // å…¨éƒ¨æ‰§è¡Œ
      
      return true
    }
  })
}

const data = { text: 'hello world' }
const refData = ref(data)
function effect() {
  const res = refData.text
  console.log(res) // ä¸€èˆ¬ä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œæ“ä½œdomï¼Œæˆ–å…¶ä»–å…±äº«çŠ¶æ€
}

createEffect(effect) // <-- âœ¨ è®°å½•å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹) é¿å…å†™æ­»ä½¿ç”¨æ–¹å‡½æ•°å
setTimeout(() => {
  refData.text = 'hello vue3'
}, 1000);
```

å› ä¸º `const depsMap` è¢«èµ‹å€¼ä¸º undefined äº†ï¼Œå³ä½¿åé¢é©¬ä¸Šè®¾ç½®äº†åˆå§‹å€¼ï¼Œä½†é‚£æ˜¯ bucket çš„å€¼ï¼Œå› æ­¤è¦åœ¨getä¸€æ¬¡

è¿™é‡Œè¿™æ ·ç®€å†™ğŸ‘‡ 

```js
let depsMap = bucket.get(target)
if(!depsMap) {
  bucket.set(target, (depsMap = new Map()))
}

let depsFns = depsMap.get(key)
if(!depsFns) {
  depsMap.set(key, (depsFns = new Set()))
}
```

æˆ‘ä»¬è¿™æ ·è¾“å‡ºä¸€ä¸ªjsèµ‹å€¼è¡¨è¾¾å¼ï¼š `let a = 1; console.log((a = 2)` ä¼šå¾—åˆ°èµ‹å€¼å a çš„å€¼ --> 2

```js
let activeEffect = null // <-- âœ¨ ä¸´æ—¶å˜é‡ å­˜éœ€è¦è®°å½•çš„å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹)
const createEffect = (fn) => {
  activeEffect = fn
  fn()
}

const bucket = new Map()
const ref = (data) => {
  return new Proxy(data, {
    get(target, key) {

      let depsMap = bucket.get(target)
      if(!depsMap) {
        bucket.set(target, (depsMap = new Map())) // <-- âœ¨ åˆå§‹åŒ–æ•°æ®ç»“æ„ åŒæ—¶èµ‹å€¼
      }

      let depsFns = depsMap.get(key)
      if(!depsFns) {
        depsMap.set(key, (depsFns = new Set()))
      }

      depsFns.add(activeEffect) // å†™æ­»ä½¿ç”¨dataæ•°æ®çš„æ˜¯ activeEffect å˜é‡
      return target[key]
    },

    set(target, key, newVal) {
      target[key] = newVal

      const depsMap = bucket.get(target)
      const depsFns = depsMap.get(key)
      depsFns.forEach(fn => fn()) // å…¨éƒ¨æ‰§è¡Œ

      return true
    }
  })
}

const data = { text: 'hello world' }
const refData = ref(data)
function effect() {
  const res = refData.text
  console.log(res) // ä¸€èˆ¬ä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œæ“ä½œdomï¼Œæˆ–å…¶ä»–å…±äº«çŠ¶æ€
}

createEffect(effect) // <-- âœ¨ è®°å½•å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹) é¿å…å†™æ­»ä½¿ç”¨æ–¹å‡½æ•°å
setTimeout(() => {
  refData.text = 'hello vue3'
}, 1000);
```


```js
const map = new Map()
const weakmap = new WeakMap()

(() => {
  const foo = {foo:1}
  const bar = {bar:1}

  map.set(foo, 1)
  weakmap.set(bar, 1)
})()
```

![](https://kingan-md-img.oss-cn-guangzhou.aliyuncs.com/blog/20230409170031.png)

ä¸åœ¨ä»£ç ä¸­è¯»å– `foo` å’Œ `bar`, å„map setæ—¶æ˜¯æœ€åä¸€æ¬¡è¯»å–ï¼Œåƒåœ¾å›æ”¶å°†å¼€å§‹æ¸…é™¤

æ­¤æ—¶è¾“å‡º `map` å’Œ `weakmap` è¡Œä¸ºä¸ç›¸åŒ


ğŸ‘‡ ä½¿ç”¨ `WeakMap` å¹¶ æŠ½è±¡å‡º `è¿½è¸ª(track)`ã€`è§¦å‘(trigger)` å‡½æ•°
```js
let activeEffect = null // <-- âœ¨ ä¸´æ—¶å˜é‡ å­˜éœ€è¦è®°å½•çš„å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹)
const createEffect = (fn) => {
  activeEffect = fn
  fn()
}

// âœ¨ è¿½è¸ª åˆ›å»ºå“åº”å¼æ•°æ®å’Œå‰¯ä½œç”¨å‡½æ•°çš„å¯¹åº”å…³ç³»æ•°æ®ç»“æ„
const track = (target, key) => {
  let depsMap = bucket.get(target)
  if(!depsMap) {
    bucket.set(target, (depsMap = new Map())) // <-- âœ¨ åˆå§‹åŒ–æ•°æ®ç»“æ„ åŒæ—¶èµ‹å€¼
  }

  let depsFns = depsMap.get(key)
  if(!depsFns) {
    depsMap.set(key, (depsFns = new Set()))
  }

  depsFns.add(activeEffect) // å†™æ­»ä½¿ç”¨dataæ•°æ®çš„æ˜¯ activeEffect å˜é‡
}

// âœ¨ è§¦å‘ æ‰¾åˆ°å˜åŠ¨æ•°æ®å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ
const trigger = (target, key) => {
  const depsMap = bucket.get(target)
  const depsFns = depsMap.get(key)
  depsFns.forEach(fn => fn()) // å…¨éƒ¨æ‰§è¡Œ
}

const bucket = new WeakMap() // âœ¨ WeakMap å¤–éƒ¨ä¸šåŠ¡ä»£ç ä¸å†ä½¿ç”¨å“åº”å¼æ•°æ®æ—¶è‡ªåŠ¨å›æ”¶
const ref = (data) => {
  return new Proxy(data, {
    get(target, key) {
      track(target, key) // âœ¨ è¿½è¸ª åˆ›å»ºå“åº”å¼æ•°æ®å’Œå‰¯ä½œç”¨å‡½æ•°çš„å¯¹åº”å…³ç³»æ•°æ®ç»“æ„
      return target[key]
    },

    set(target, key, newVal) {
      target[key] = newVal
      trigger(target, key) // âœ¨ è§¦å‘ æ‰¾åˆ°å˜åŠ¨æ•°æ®å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ‰§è¡Œ

      return true
    }
  })
}

const data = { text: 'hello world' }
const refData = ref(data)
function effect() {
  const res = refData.text
  console.log(res) // ä¸€èˆ¬ä¸ºå‰¯ä½œç”¨å‡½æ•°ï¼Œæ“ä½œdomï¼Œæˆ–å…¶ä»–å…±äº«çŠ¶æ€
}

createEffect(effect) // <-- âœ¨ è®°å½•å‰¯ä½œç”¨å‡½æ•°(ä½¿ç”¨å“åº”å¼æ•°æ®æ–¹) é¿å…å†™æ­»ä½¿ç”¨æ–¹å‡½æ•°å
setTimeout(() => {
  refData.text = 'hello vue3'
}, 1000);
```